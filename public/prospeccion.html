<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>CRM Pietra Fina - Módulo de Prospección</title>

        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap"
            rel="stylesheet"
        />
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            playfair: ['"Playfair Display"', "serif"],
                            inter: ['"Inter"', "sans-serif"],
                        },
                         colors: {
                            'brand-red': '#DC2626',
                            'brand-dark': '#111827',
                            'brand-light': '#F9FAFB',
                        }
                    },
                },
            };
        </script>
        <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <link rel="stylesheet" href="./style.css" />
        <style type="text/tailwindcss">
            @layer components {
                .font-playfair {
                    font-family: "Playfair Display", serif;
                }
                .btn {
                    @apply inline-flex items-center justify-center gap-2 rounded-lg px-4 py-2.5 text-sm font-semibold shadow-sm transition-all focus:outline-none focus:ring-2 focus:ring-offset-2;
                }
                .btn-primary {
                    @apply border border-transparent bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
                }
                .btn-secondary {
                    @apply border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-indigo-500;
                }
                .btn-danger {
                    @apply border border-transparent bg-red-600 text-white hover:bg-red-700 focus:ring-red-500;
                }
                .btn-success {
                    @apply border border-transparent bg-green-600 text-white hover:bg-green-700 focus:ring-green-500;
                }
                .form-input,
                .form-select {
                    @apply w-full rounded-lg border-gray-300 shadow-sm focus:border-red-500 focus:ring-red-500;
                }
                .sidebar {
                    @apply fixed inset-y-0 left-0 z-50 flex h-full w-64 -translate-x-full flex-col border-r border-gray-200 bg-white transition-transform duration-300 ease-in-out lg:translate-x-0;
                }
                .main-content-wrapper {
                    @apply flex flex-1 flex-col transition-[margin-left] duration-300 ease-in-out lg:ml-64;
                }
                .main-content {
                    @apply flex-1 overflow-y-auto p-6 md:p-8;
                }
                .modal-backdrop {
                    @apply fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 transition-opacity duration-300;
                    display: none; /* Oculto por defecto */
                }
                .modal-content {
                    @apply flex h-[90vh] w-[95vw] max-w-4xl transform flex-col rounded-xl bg-white shadow-2xl transition-transform duration-300;
                }
                .modal-header {
                    @apply flex items-start justify-between border-b p-5;
                }
                .modal-title {
                    @apply text-xl font-bold font-playfair text-gray-900;
                }
                .modal-close-btn {
                    @apply rounded-full p-1 text-gray-500 hover:bg-gray-100;
                }
                .modal-footer {
                    @apply flex-shrink-0 rounded-b-xl border-t bg-gray-50 p-4;
                }
                .prospect-card {
                    @apply rounded-xl border bg-white shadow-sm transition-all hover:shadow-md;
                }
                .prospect-card-header {
                    @apply flex items-center justify-between border-b p-4;
                }
                .prospect-card-body {
                    @apply grid grid-cols-1 gap-4 p-4 md:grid-cols-2;
                }
                .prospect-card-footer {
                    @apply flex items-center justify-end gap-2 border-t bg-gray-50 p-3;
                }
                .prospect-card-status {
                    @apply rounded-full px-2.5 py-0.5 text-xs font-semibold;
                }
                .status-pendiente {
                    @apply bg-yellow-100 text-yellow-800;
                }
                .status-prospeccion {
                    @apply bg-blue-100 text-blue-800;
                }
                .status-interesado {
                    @apply bg-green-100 text-green-800;
                }
                .status-rechazado,
                .status-convertido,
                .status-cliente {
                    @apply bg-gray-100 text-gray-600;
                }
                .section-header {
                    @apply mb-4 border-b pb-2 text-lg font-semibold font-playfair text-gray-800;
                }
            }
        </style>
        <style type="text/tailwindcss">
            .toggle-switch-container {
                @apply flex items-center justify-start gap-3 rounded-lg bg-white px-4 py-2 shadow-sm border border-gray-200;
            }
            .toggle-switch-label {
                @apply text-sm font-medium text-gray-700 cursor-pointer;
            }
            .toggle-switch {
                @apply relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2;
                background-color: #e5e7eb; /* gray-200 */
            }
            .toggle-switch.active {
                background-color: #dc2626; /* brand-red */
            }
            .toggle-slider {
                @apply pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out;
                transform: translateX(0);
            }
            .toggle-switch.active .toggle-slider {
                transform: translateX(1.25rem); /* 20px */
            }
        </style>
        <style type="text/tailwindcss">
            @layer components {
                /* Sidebar móvil y overlay */
                .page-overlay { @apply hidden fixed inset-0 z-40 bg-black/50 transition-opacity duration-300; }
                body.sidebar-open .page-overlay { @apply block; }
                body.sidebar-open .sidebar { @apply translate-x-0; }

                /* Lista de prospectos (tabla responsive ligera) */
                .prospect-list-container { @apply rounded-lg border border-gray-200 bg-white shadow-sm; }
                .prospect-list-header { @apply grid grid-cols-5 gap-4 border-b bg-gray-50 px-4 py-3; }
                .prospect-header-cell { @apply text-xs font-medium uppercase tracking-wide text-gray-500; }
                .prospect-list-body { @apply divide-y; }
                .prospect-row { @apply grid grid-cols-5 items-center gap-4 px-4 py-3; }
                .prospect-cell { @apply text-sm text-gray-700 truncate; }
                .prospect-actions-cell { @apply flex items-center justify-end gap-2; }
                .btn-sm { @apply rounded-md px-2.5 py-1.5 text-xs font-medium; }
                .prospect-section-header-toggle { @apply border-b border-gray-200; }

                /* Planificador Semanal */
                .weekly-planner { @apply grid gap-4 lg:grid-cols-5; }
                .planner-day-column { @apply rounded-lg border border-gray-200 bg-white shadow-sm; }
                .planner-day-column.is-today { @apply ring-2 ring-red-500/40; }
                .planner-day-column.is-overdue { @apply border-red-200; }
                .planner-day-header { @apply flex items-center justify-between px-4 py-3 cursor-pointer; }
                .planner-task-count { @apply inline-flex h-6 min-w-6 items-center justify-center rounded-full bg-red-100 px-2 text-xs font-semibold text-red-700; }
                .planner-toggle-icon { @apply transition-transform; }
                .planner-toggle-icon.is-rotated { @apply rotate-180; }
                .planner-prospects-list { @apply px-3 pb-3; }
                .planner-prospects-list.is-collapsible { max-height: 0; overflow: hidden; transition: max-height 0.25s ease; }
                .planner-prospects-list.is-collapsible.is-expanded { max-height: 1000px; }
                .planner-prospect-card { @apply mt-3 cursor-pointer rounded-md border border-gray-200 bg-white p-3 shadow-sm transition hover:shadow-md; }

                /* Snackbar */
                .snackbar { @apply fixed top-4 right-4 z-[1000] flex items-center gap-2 rounded-lg px-4 py-2 text-sm text-white shadow-lg opacity-0 -translate-y-1 transition-all; background-color: #111827; }
                .snackbar.show { @apply opacity-100 translate-y-0; }
                .snackbar.success { @apply bg-green-600; }
                .snackbar.error { @apply bg-red-600; }
                .snackbar.info { @apply bg-slate-800; }

                /* Modal base (coherente con Gestión) */
                .modal-backdrop { @apply fixed inset-0 z-[100] hidden items-center justify-center bg-black/50 backdrop-blur-sm transition-opacity duration-300; }
                .modal-content { @apply flex h-[90vh] w-[95vw] max-w-4xl transform flex-col rounded-2xl bg-white shadow-2xl transition-transform duration-300 border border-gray-200; }
                .modal-header { @apply sticky top-0 z-10 flex items-start justify-between border-b p-5 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/70; }
                .modal-title { @apply text-2xl font-bold font-playfair text-gray-900 tracking-tight; }
                .modal-close-btn { @apply rounded-full p-2 text-gray-500 hover:bg-gray-100; }
                .modal-footer { @apply sticky bottom-0 z-10 flex-shrink-0 rounded-b-2xl border-t bg-white/80 p-4 backdrop-blur supports-[backdrop-filter]:bg-white/70; }
                .is-open { display: flex !important; }

                /* Detalle: columnas y tarjetas de notas (coherente con Gestión) */
                .detail-grid { @apply grid grid-cols-1 lg:grid-cols-3 gap-6; }
                .detail-notes { @apply lg:col-span-2; }
                .detail-notes h4 { @apply text-base font-semibold text-gray-800 mb-3; }
                .note-item { @apply rounded-lg border border-gray-200 bg-white shadow-sm px-4 py-3 transition hover:shadow-md; }
                .detail-sidebar { @apply lg:col-span-1 rounded-xl border border-gray-200 bg-gray-50/60 p-4; }
                .detail-sidebar .section { @apply border-b last:border-b-0 pb-4 mb-4; }
                .detail-sidebar .label { @apply text-sm text-gray-600 flex items-center gap-2; }
                .detail-sidebar .value { @apply font-semibold text-gray-900; }

                /* Chips de materiales (lista vertical ordenada visualmente) */
                .material-checkbox-label { @apply flex items-center w-full; }
                .material-checkbox-label span { @apply inline-flex w-full items-center justify-start text-left break-words gap-2 rounded-lg border border-gray-200 bg-white px-3 py-2 text-sm font-medium text-gray-800 transition; }
                .material-checkbox-label input { position: absolute; opacity: 0; width: 1px; height: 1px; }
                .material-checkbox-label input:checked + span { @apply border-red-300 bg-red-50 text-red-700; }
            }
        </style>
    </head>
    <body class="font-inter bg-brand-light">
        <div class="page-overlay lg:hidden"></div>

        <!-- SIDEBAR DE NAVEGACIÓN -->
        <aside class="sidebar">
             <div class="sidebar-header p-4">
                 <a href="./dashboard.html" class="flex items-center justify-center">
                    <img
                        src="./assets/logo.png"
                        alt="Logo Pietra Fina"
                        class="h-16 md:h-20 w-auto object-contain"
                    />
                </a>
            </div>
            <nav class="sidebar-nav flex-1 p-4 space-y-2">
                 <a href="./dashboard.html" class="flex items-center gap-3 rounded-lg px-3 py-2 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Dashboard</span>
                </a>
                <a href="./admin-app.html" class="flex items-center gap-3 rounded-lg px-3 py-2 text-gray-600 hover:bg-gray-50">
                    <i data-lucide="users"></i>
                    <span>Gestión</span>
                </a>
                <a href="./prospeccion.html" class="flex items-center gap-3 rounded-lg bg-gray-100 px-3 py-2 text-gray-900">
                    <i data-lucide="target"></i>
                    <span>Prospección</span>
                </a>
            </nav>
            <div class="sidebar-footer mt-auto border-t p-4">
                 <div class="flex items-center gap-3">
                        <div
                            class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-200 font-bold text-gray-700"
                            id="user-initials"
                        ></div>
                        <div>
                            <p class="font-semibold" id="user-name-display">
                                Cargando...
                            </p>
                        </div>
                        <button
                            id="logout-btn"
                            class="ml-auto rounded-md p-2 text-gray-500 hover:bg-gray-100"
                            aria-label="Cerrar sesión"
                        >
                            <i data-lucide="log-out" class="h-5 w-5"></i>
                        </button>
                    </div>
            </div>
        </aside>

        <!-- CONTENEDOR PRINCIPAL -->
        <div class="main-content-wrapper">
            <main class="main-content">
                <header
                    class="sticky top-0 z-10 flex h-16 items-center justify-between border-b bg-white/50 px-4 backdrop-blur-sm md:justify-end lg:hidden"
                >
                    <button
                        id="menu-toggle-btn"
                        class="rounded-md p-2 text-gray-600 hover:bg-gray-100 md:hidden"
                        aria-label="Abrir menú"
                    >
                        <i data-lucide="menu" class="h-6 w-6"></i>
                    </button>
                    <h1 class="font-playfair text-xl font-bold">
                        Prospección
                    </h1>
                    <div></div>
                </header>

                <div class="p-4 md:p-6">
                    <div class="mb-8">
                        <h1 class="font-playfair text-3xl font-bold text-brand-dark">Módulo de Prospección</h1>
                        <p class="text-gray-500">Enfócate en los prospectos que necesitan tu atención hoy.</p>
                    </div>

                    <!-- PLANIFICADOR SEMANAL -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="flex items-center text-xl font-playfair font-bold text-black">
                                <i data-lucide="calendar-days" class="w-5 h-5 mr-3 text-red-600"></i>
                                Planificador Semanal
                            </h3>
                        </div>
                        <div id="weekly-planner-container"></div>
                    </div>

                    <div class="mb-6 border-t pt-6">
                         <h3 class="flex items-center text-xl font-playfair font-bold text-black mb-4">
                            <i data-lucide="filter" class="w-5 h-5 mr-3 text-red-600"></i>
                            Filtros de Prospección
                        </h3>
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-3">
                                <div class="relative col-span-1 sm:col-span-2 lg:col-span-1">
                                    <i data-lucide="search" class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2"></i>
                                    <input
                                        type="text"
                                        id="searchFilter"
                                        placeholder="Buscar por Nombre..."
                                        class="form-input w-full pl-10"
                                    />
                                </div>
                                <select id="statusFilter" class="form-select col-span-1">
                                    <option value="active">Prospectos Activos</option>
                                    <option value="Interesado">Solo Interesados</option>
                                    <option value="En Prospección">Solo En Prospección</option>
                                </select>
                                <select id="sortFilter" class="form-select col-span-1">
                                    <option value="followup_asc">Próximo Seguimiento</option>
                                    <option value="latest">Más Recientes</option>
                                    <option value="oldest">Más Antiguos</option>
                                </select>
                            </div>
                            <div class="toggle-switch-container">
                                <div id="stagnant-filter-toggle" class="toggle-switch" role="switch" aria-checked="false">
                                    <div class="toggle-slider"></div>
                                </div>
                                <label for="stagnant-filter-toggle" class="toggle-switch-label">Mostrar sólo prospectos que requieren acción</label>
                            </div>
                        </div>
                    </div>

                    <!-- LISTA DE PROSPECTOS -->
                    <div id="prospeccion-cards-container" class="space-y-6"></div>
                    <div id="prospeccion-no-prospects" class="hidden text-center py-20 bg-white rounded-lg mt-8 shadow-sm border">
                        <i data-lucide="archive" class="w-12 h-12 text-gray-400 mx-auto mb-4"></i>
                        <p class="text-xl text-gray-800 font-semibold">No hay prospectos que coincidan con los filtros</p>
                        <p class="text-gray-500 mt-2">Intenta con otros criterios de búsqueda.</p>
                    </div>
                </div>
            </main>
        </div>

        <!-- MODALES -->
        <div id="detail-modal" class="modal-backdrop">
            <div id="detail-modal-content" class="modal-content max-w-6xl">
                <div class="modal-header">
                    <div>
                        <h3 class="modal-title" id="detail-businessName">Detalle del Prospecto</h3>
                        <p id="detail-status" class="text-sm font-semibold text-red-600">—</p>
                    </div>
                    <button id="detail-close-btn" class="modal-close-btn" aria-label="Cerrar">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="flex-1 overflow-y-auto p-5">
                    <div id="detail-display-view" class="detail-grid">
                        <div class="detail-notes">
                            <h4 class="text-base font-semibold text-gray-800 mb-3">Historial de Seguimiento</h4>
                            <div id="detail-followUpNotes" class="space-y-3"></div>
                            <form id="add-note-form" class="mt-4 space-y-3">
                                <textarea id="add-note-textarea" class="form-input" rows="3" placeholder="Escribe una nota..."></textarea>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-sm text-gray-600">Próximo seguimiento</label>
                                        <input id="next-followup-input" class="form-input" type="text" placeholder="Selecciona fecha" />
                                    </div>
                                    <div class="flex items-end justify-end gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i data-lucide="save"></i>
                                            Guardar Nota
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <aside class="detail-sidebar">
                            <h4 class="text-base font-semibold text-gray-800 mb-3">Datos del Prospecto</h4>
                            <div class="section">
                                <p class="label"><i data-lucide="user-2" class="w-4 h-4"></i> Contacto</p>
                                <p id="detail-contactPerson" class="value">—</p>
                            </div>
                            <div class="section">
                                <p class="label"><i data-lucide="mail" class="w-4 h-4"></i> Correo</p>
                                <p id="detail-email" class="value">—</p>
                            </div>
                            <div class="section">
                                <p class="label"><i data-lucide="phone" class="w-4 h-4"></i> Teléfono</p>
                                <p id="detail-phone" class="value">—</p>
                            </div>
                            <div class="section">
                                <p class="label"><i data-lucide="badge-check" class="w-4 h-4"></i> Clasificación</p>
                                <p id="detail-classification" class="value">—</p>
                            </div>
                            <div class="section">
                                <p class="label"><i data-lucide="calendar" class="w-4 h-4"></i> Próximo Seguimiento</p>
                                <p id="detail-nextFollowUpDate" class="value">—</p>
                            </div>
                            <div class="section">
                                <p class="label"><i data-lucide="file-text" class="w-4 h-4"></i> Observaciones</p>
                                <p id="detail-observations" class="text-gray-800">Sin observaciones.</p>
                            </div>
                        </aside>
                    </div>

                    <div id="detail-edit-view" class="hidden">
                        <form id="edit-prospect-form" class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input id="edit-businessName" name="businessName" class="form-input" placeholder="Razón Social" />
                                <input id="edit-contactPerson" name="contactPerson" class="form-input" placeholder="Contacto" />
                                <input id="edit-email" name="email" type="email" class="form-input" placeholder="Email" />
                                <input id="edit-phone" name="phone" class="form-input" placeholder="Teléfono" />
                                <select id="edit-classification" name="classification" class="form-select"></select>
                                <select id="edit-status" name="status" class="form-select">
                                    <option>Pendiente de Correo</option>
                                    <option>En Prospección</option>
                                    <option>Interesado</option>
                                    <option>Rechazado</option>
                                    <option>Convertido a cliente</option>
                                    <option>Ya es nuestro cliente</option>
                                </select>
                                <textarea id="edit-observations" name="observations" class="form-input md:col-span-2" rows="3" placeholder="Observaciones"></textarea>
                                <div>
                                    <label class="text-sm text-gray-600">Próximo seguimiento</label>
                                    <input id="edit-nextFollowUpDate" name="nextFollowUpDate" class="form-input" type="text" placeholder="Selecciona fecha" />
                                </div>
                            </div>
                            <div class="flex items-center justify-end gap-2">
                                <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancelar</button>
                                <button type="submit" class="btn btn-primary">Guardar</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="flex w-full items-center gap-3">
                        <button id="edit-prospect-btn" class="btn btn-secondary flex-1">
                            <i data-lucide="pencil"></i>
                            Editar Prospecto
                        </button>
                        <button id="delete-prospect-btn" class="btn btn-danger">
                            <i data-lucide="trash-2"></i>
                            Eliminar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="confirm-modal" class="modal-backdrop">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="confirm-modal-title" class="modal-title">Confirmar</h3>
                    <button id="confirm-cancel-btn" class="modal-close-btn" aria-label="Cancelar">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="p-5">
                    <p id="confirm-modal-message" class="text-sm text-gray-700">¿Estás seguro?</p>
                </div>
                <div class="modal-footer">
                    <div class="ml-auto flex items-center gap-2">
                        <button id="confirm-action-btn" class="btn btn-primary">Aceptar</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="whatsapp-modal" class="modal-backdrop">
            <div class="modal-content max-w-4xl">
                <div class="modal-header">
                    <div>
                        <h3 class="modal-title">Enviar WhatsApp a <span id="whatsapp-prospect-name">—</span></h3>
                        <p class="text-sm text-gray-600">Selecciona materiales y personaliza tu mensaje</p>
                    </div>
                    <button id="whatsapp-close-btn" class="modal-close-btn" aria-label="Cerrar">
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-5">
                        <section class="rounded-xl border border-gray-200 bg-white p-4">
                            <h4 class="text-sm font-semibold text-gray-800 mb-3">Materiales a adjuntar</h4>
                            <div id="materials-checkbox-container" class="flex flex-col gap-2 max-h-72 overflow-auto pr-1"></div>
                            <p class="mt-3 text-xs text-gray-500">Los enlaces se insertarán automáticamente en el mensaje.</p>
                        </section>
                        <section class="rounded-xl border border-gray-200 bg-white p-4 flex flex-col">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="text-sm font-semibold text-gray-800">Mensaje</h4>
                                <span class="text-xs text-gray-500">Vista previa</span>
                            </div>
                            <textarea id="whatsapp-message-textarea" class="form-input flex-1 min-h-[14rem]" placeholder="Contenido del mensaje"></textarea>
                            <div class="mt-2 text-xs text-gray-500">
                                Consejo: Personaliza el saludo con el nombre y añade contexto breve antes de los enlaces.
                            </div>
                        </section>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="flex w-full items-center gap-3">
                        <button class="btn btn-secondary" onclick="document.getElementById('whatsapp-close-btn').click()">
                            <i data-lucide="x-circle"></i>
                            Cancelar
                        </button>
                        <button id="whatsapp-send-btn" class="btn btn-success flex-1">
                            <i data-lucide="send"></i>
                            Enviar por WhatsApp
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script type="module" src="./firebase.js"></script>
        <script type="module" src="./ui.js"></script>
        <script type="module" src="./api.js"></script>
        <script type="module" src="./prospeccion-script.js"></script>
        <script type="module" src="./navigation.js"></script>
        <script>
            lucide.createIcons();
        </script>
    </body>
</html>
